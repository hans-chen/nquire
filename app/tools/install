#!/bin/sh
#
# usage: install [install options] [main.lua options]
# install options: -a    all (first remove current installation completely)
#                  -i    install only (do not start app)
# e.g:
# ./install -a -n
# Start main without ethernet network (re)configuration

killall lua
sleep 1

if ! cd /cit200; then
	exit
fi

if mount | grep workspace > /dev/null; then 

	echo "Mounted to `mount | grep workspace`"
	echo "Not copying files"

else

	if test "$1" == "-a"; then
		shift
		cd /cit200 && rm -rf *
		ifdown eth0
		ifdown wlan0
	fi

	#set -x
	sync_file ( )
	{
		if ! test -f $2; then
			echo "New file: $2"
			cp -a $1 $2
		else
			if ! diff $1 $2 > /dev/null; then 
				echo "Changed file: $2"
				cp -a $1 $2
			fi
		fi
	}
		
	# copy files that are different:
	cd /home/ftp
	mkdir app-tmp
	cd app-tmp
	tar xf ../app.tar
	DIRS=`find . -type d`
	cd /cit200
	mkdir -p $DIRS
	cd /home/ftp/app-tmp
	for f in `find . -type f`; do 
		sync_file "/home/ftp/app-tmp/$f" "/cit200/$f"
	done
	sync_file "/home/ftp/install" "/cit200/install" 
	chmod +x /cit200/install
	cd /cit200
	rm -rf /home/ftp/app-tmp
fi

if ! test "$1" == "-i"; then
	sleep 2
	set -x
	lua main.lua $1 $2 $3 $4 $5 2>&1 &
fi

