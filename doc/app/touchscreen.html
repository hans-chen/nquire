<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.2.7" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock {
  margin-right: 0%;
}
div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock {
  padding-left: 2.0em;
}
div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock {
  padding-left: 2.0em;
}
div.verseblock > div.content {
  white-space: pre;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
div.olist > ol {
  list-style-type: decimal;
}
div.olist2 > ol {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hlist td {
  padding-bottom: 15px;
}
td.hlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock-content {
  white-space: pre;
}
div.verseblock-attribution {
  padding-top: 0.75em;
  text-align: left;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }

/* Because IE6 child selector is broken. */
div.olist2 ol {
  list-style-type: lower-alpha;
}
div.olist2 div.olist ol {
  list-style-type: decimal;
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){generateToc(2)}
/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, October 2006. License: GPL */

function getText(el) {
  var text = "";
  for (var i = el.firstChild; i != null; i = i.nextSibling) {
    if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
      text += i.data;
    else if (i.firstChild != null)
      text += getText(i);
  }
  return text;
}

function TocEntry(el, text, toclevel) {
  this.element = el;
  this.text = text;
  this.toclevel = toclevel;
}

function tocEntries(el, toclevels) {
  var result = new Array;
  var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
  // Function that scans the DOM tree for header elements (the DOM2
  // nodeIterator API would be a better technique but not supported by all
  // browsers).
  var iterate = function (el) {
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
        var mo = re.exec(i.tagName)
        if (mo)
          result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
        iterate(i);
      }
    }
  }
  iterate(el);
  return result;
}

// This function does the work. toclevels = 1..4.
function generateToc(toclevels) {
  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementsByTagName("body")[0], toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "toc" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    document.getElementById("header").removeChild(toc);
}
/*]]>*/
</script>
<title>Nquire touchscreen</title>
</head>
<body>
<div id="header">
<h1>Nquire touchscreen</h1>
<span id="author">Maarten van Dootingh</span><br />
<span id="email"><tt>&lt;<a href="mailto:maarten@vdtai.nl">maarten@vdtai.nl</a>&gt;</tt></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="para"><p>Revision history</p></div>
<div class="tableblock">
<table rules="none"
frame="hsides"
cellspacing="0" cellpadding="4">
<col width="91" />
<col width="274" />
<col width="708" />
<tbody valign="top">
  <tr>
    <td align="left">
    v1.0
    </td>
    <td align="left">
    Januari 2010
    </td>
    <td align="left">
    New
    </td>
  </tr>
  <tr>
    <td align="left">
    v1.1
    </td>
    <td align="left">
    April 2 2010
    </td>
    <td align="left">
    Documenting implicit exclusion of external scanner
    </td>
  </tr>
</tbody>
</table>
</div>
<div class="para"><p>This document describes the requirements and design for how the NQuire
application should handle the touchscreen functionality.</p></div>
</div>
</div>
<h2 id="_context">1. Context</h2>
<div class="sectionbody">
<h3 id="_customer">1.1. Customer</h3><div style="clear:left"></div>
<div class="para"><p>Some customers require a possebility to interact with the NQuire. An example of
this could be an application of the NQuire in a casino for upgrading a value
card.</p></div>
<div class="para"><p>Choosen is to have a touchscreen for this. The NQuire should still remain a
dumb device, knowning knothing of the application it serves. This means it
will only offer the possibility to use the touchscreen. The actual application
giving the touch-screen-input meaning, is to be in the customers server.</p></div>
<h3 id="_hardware">1.2. Hardware</h3><div style="clear:left"></div>
<div class="para"><p>The touchscreen is a hardware option on the NQuire.
This touchscreen has a capacitive matrix of 4x4 touch-area (<em>keys</em>).
The firmware is extended with an extra device: <tt>/dev/event0</tt></p></div>
<div class="para"><p>This device spawns <tt>struct input_event</tt> formatted data.</p></div>
</div>
<h2 id="_requirements">2. Requirements</h2>
<div class="sectionbody">
<div class="para"><p>R.kp.1 - The server should be able to be notified of all touch-key-press events.</p></div>
<div class="para"><p>R.kp.2 - It shall be possible to have a grafical touch-key visualisation.</p></div>
<div class="para"><p>R.kp.2.1 - A touch key can be related to an image (gif)</p></div>
<div class="para"><p>R.kp.2.2 - A key-press event is to be visualised.</p></div>
<div class="para"><p>R.kp.2.2.2 - It shall be possible to relate a different image to the released
        as to the pressed state of a touch-key.</p></div>
<div class="para"><p>R.kp.2.3 - It shall be possible to relate one image to more than 1 touch-key.</p></div>
<div class="para"><p>R.kp.2.3.1 - Images are of arbitray size (uploaded images can be smaller or bigger than 1 touch-key).</p></div>
<div class="para"><p>R.kp.2.3.2 - An image is visualised the moment a relation is made.</p></div>
<div class="para"><p>R.kp.2.3.3 - There shall be a timeout on the touchscreen visualisation, counting
        from the last key-press or layout-update.</p></div>
<div class="para"><p>R.kp.2.3.3.1 - The timeout shall be configurable (and can be indefinite).</p></div>
<div class="para"><p>R.kp.2.3.4 - All clients (udp/tcp) shall be notified of the timeout-event.</p></div>
<div class="para"><p>R.kp.2.3.5 - The screen shall be blanked upon a timeout.
        The normal <tt>welcome</tt> text is displayed after the idle-timeout <tt>cit.conf /cit/messages/idle/timeout</tt></p></div>
<div class="para"><p>R.kp.2.5 - The following default images shall be available:</p></div>
<div class="para"><p>R.kp.2.5.1 - 1 key-size button images:
        0.gif        a.gif       cross.gif
        1.gif        b.gif       mul.gif
        2.gif        c.gif           div.gif
        3.gif        d.gif       add.gif
        4.gif        e.gif       sub.gif
        5.gif        f.gif       assign.gif
        6.gif        info.gif    down.gif
        7.gif        cancel.gif  up.gif
        8.gif        cr.gif      right.gif
        9.gif        ok.gif      left.gif
        reset.gif    ok_sign.gif</p></div>
<div class="para"><p>R.kp.2.6 - It shall be possible to upload alternate images.</p></div>
<div class="para"><p>R.kp.2.6.1 - Image names should not contain spaces or a path</p></div>
<div class="para"><p>R.kp.2.6.3 - The upload client is responsible for correct format of the image</p></div>
<div class="para"><p>R.kp.2.6.4 - Only gif images will be used by the nquire</p></div>
<div class="para"><p>R.kp.2.6.4.1 - It is possible to use animated gif images</p></div>
<div class="para"><p>R.kp.2.6.4.2 - The images should be 2 colors: white=255,g=255,b=255
        and black=0,g=0,b=0. Pure blue=0,g=0,b=255 is interpreted as
        transparent color.</p></div>
<div class="para"><p>R.kp.3 - It shall be possible to write text <em>over</em> the touch-screen layout
        using escape commands.</p></div>
<h3 id="_constraints">2.1. Constraints</h3><div style="clear:left"></div>
<div class="ilist"><ul>
<li>
<p>
It is not possible to use an external scanner on an nquire with a touchscreen.
        This is a driver contraint: the touchscreen outputs via
        stdin as well as the external scanner. Both datastreams will be mixed, which
        will give inconclusive results
        Therefore external scanner input is ignored when a touchscreen is detected.
</p>
</li>
</ul></div>
<h3 id="_unclear">2.2. Unclear</h3><div style="clear:left"></div>
<div class="literalblock">
<div class="content">
<pre><tt>Q1: What to do when a image is not available for positioning?
A1: The command is simply ignored</tt></pre>
</div></div>
</div>
<h2 id="_design">3. Design</h2>
<div class="sectionbody">
<h3 id="_escape_command_interface">3.1. Escape command interface</h3><div style="clear:left"></div>
<div class="para"><p>The following extra escape commands are to be implemented:</p></div>
<div class="ilist"><ul>
<li>
<p>
<tt>\xf0 &lt;image name&gt; \x03</tt> : show image
</p>
<div class="olist2"><ol>
<li>
<p>
position image with \x2c (set pixel position)
</p>
</li>
<li>
<p>
only gif images allowed
</p>
</li>
</ol></div>
</li>
<li>
<p>
<tt>\xf2 &lt;name released&gt; \x0d &lt;name pressed&gt; \x0d &lt;pos key-id&gt; &lt;coupled to key-id&gt;n \x03</tt> : relate image to touch-key
</p>
<div class="olist2"><ol>
<li>
<p>
When only 1 key is coupled, usually &lt;pos key-id&gt; == &lt;coupled to key-id&gt;
</p>
</li>
<li>
<p>
the <tt>name</tt> the name of the gif-image without the <tt>.gif</tt> extension.
</p>
</li>
<li>
<p>
it is possible to couple an image to more than 1 touch-key, simply by specifying more than 1 key-id.
</p>
</li>
<li>
<p>
positions range from [0..f], starting left top:
</p>
</li>
</ol></div>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><tt>           0  1  2  3
           4  5  6  7
           8  9  a  b
           c  d  e  f</tt></pre>
</div></div>
<div class="ilist"><ul>
<li>
<p>
<tt>\xf3</tt> : show welcome text
</p>
<div class="olist2"><ol>
<li>
<p>
This forces the welcome tekst to be shown without delay.
</p>
</li>
<li>
<p>
All touch-key to image bindings are released.
</p>
</li>
</ol></div>
</li>
<li>
<p>
<tt>\xf5</tt> : clear text layer only (images stay on the screen)
</p>
</li>
</ul></div>
<h3 id="_image_upload">3.2. Image upload</h3><div style="clear:left"></div>
<div class="para"><p>Images can be uploaded with ftp.
For this, the folder <em>img</em> is available when the ftp-user is logged in.
Image upload is only available when an sd-card is inserted.
The images are directly stored on the sd-card (mount &#8212;bind). As such, the
 size of the sd-card limits the number of images.</p></div>
<div class="para"><p>When no sd card is present, it is decided that it should still be possible to
store a small amount of images. For this, a small seperate partition is created
which is mounted instead of the sd-card to /home/ftp/img. (it is not possible to
just use the remaining space of the jffs2 partition because an ftp-user
could than potiontially crash the system by uploading files until no space is
left on the jffs2 partition since that is the same partition as occupied by OS
and application files).</p></div>
<div class="para"><p>Note that there can be se serious performance degradation when there are a lot
of images (thousends?). The ftp-user is responsible for managing those images.</p></div>
<h3 id="_touch_key_press_event_messages">3.3. Touch-key-press event messages</h3><div style="clear:left"></div>
<div class="listingblock">
<div class="content">
<pre><tt>packet := prefix value &lt;CR&gt;
prefix := "K"
value  := { {'0' .. 'f'} [&lt;filename of image&gt;] } | 'T'</tt></pre>
</div></div>
<div class="para"><p>Note that:</p></div>
<div class="ilist"><ul>
<li>
<p>
the prefix is configurable in the webui.
</p>
</li>
<li>
<p>
the value always sends the touched key, followed by the filename of the image
   when an image was coupled to it. A <em>T</em> is send on a timeout.
</p>
</li>
<li>
<p>
When a touch-key is pressed without having an image coupled to it (and <tt>/dev/touch16/send_active_keys_only = true</tt>), then only the prefix followed by the key-value is send.
</p>
</li>
</ul></div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2010-04-02 09:44:46 CEST
</div>
</div>
</body>
</html>
